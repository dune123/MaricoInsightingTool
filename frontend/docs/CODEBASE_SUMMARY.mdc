# BrandBloom Insights - Codebase Summary

## ğŸ¯ Project Overview

BrandBloom Insights is a comprehensive, ultra-modular data science application for Marketing Mix Modeling (MMM) and analytics. The application uses a **simplified single-backend architecture** with Python FastAPI as the primary backend, following a 13-step wizard flow designed for both Brand Leaders and Data Scientists.

## ğŸ—ï¸ Architecture Overview

### Core Architecture Principles
- **Single Backend Architecture**: Python FastAPI handles ALL file operations (single source of truth)
- **Ultra-Modular Design**: Each component has a single responsibility
- **Context-Driven State Management**: Centralized state with React Context
- **Type-Safe Development**: Comprehensive TypeScript definitions
- **Service Layer Pattern**: Business logic separated from UI components
- **Design System First**: Semantic tokens and consistent theming

### Technology Stack
- **Frontend**: React 18 + TypeScript + Vite
- **Backend**: Python FastAPI (Primary) + Node.js Express (Auxiliary)
- **Data Processing**: pandas + openpyxl for Excel operations
- **Styling**: Tailwind CSS + shadcn/ui components
- **State Management**: React Context + useReducer
- **Charts**: Recharts
- **Build Tool**: Vite
- **Type Safety**: Full TypeScript coverage

## ğŸ“ Project Structure

### Frontend (React + TypeScript)
```
src/
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ charts/               # Data visualization components
â”‚   â”‚   â””â”€â”€ DataDistributionChart.tsx
â”‚   â”œâ”€â”€ steps/               # Individual wizard step components
â”‚   â”‚   â”œâ”€â”€ UserTypeStep.tsx
â”‚   â”‚   â”œâ”€â”€ AnalysisTypeStep.tsx
â”‚   â”‚   â”œâ”€â”€ AnalysisModeStep.tsx
â”‚   â”‚   â”œâ”€â”€ DataUploadStep.tsx
â”‚   â”‚   â”œâ”€â”€ DataSummaryStep.tsx
â”‚   â”‚   â”œâ”€â”€ BrandSelectionStep.tsx
â”‚   â”‚   â”œâ”€â”€ FilterSelectionStep.tsx
â”‚   â”‚   â”œâ”€â”€ EDAStep.tsx
â”‚   â”‚   â”œâ”€â”€ ExpectedSignsStep.tsx
â”‚   â”‚   â”œâ”€â”€ ModelBuildingStep.tsx
â”‚   â”‚   â”œâ”€â”€ ModelResultsStep.tsx
â”‚   â”‚   â””â”€â”€ OptimizerStep.tsx
â”‚   â”œâ”€â”€ ui/                  # Base UI components (shadcn)
â”‚   â””â”€â”€ wizard/              # Wizard-specific components
â”‚       â”œâ”€â”€ StepIndicator.tsx
â”‚       â””â”€â”€ WizardLayout.tsx
â”œâ”€â”€ config/                  # Configuration modules
â”‚   â””â”€â”€ stepConfig.ts        # Centralized step configuration
â”œâ”€â”€ context/
â”‚   â””â”€â”€ AnalysisContext.tsx  # Global state management
â”œâ”€â”€ services/                # Business logic services
â”‚   â”œâ”€â”€ dataProcessor.ts     # Enhanced data processing utilities
â”‚   â”œâ”€â”€ dataProcessors/      # Modular data processors
â”‚   â”‚   â”œâ”€â”€ baseDataProcessor.ts
â”‚   â”‚   â”œâ”€â”€ mockDataProcessor.ts
â”‚   â”‚   â””â”€â”€ csvDataProcessor.ts
â”‚   â”œâ”€â”€ fileService.ts       # Python backend file operations with data quality enhancement
â”‚   â”œâ”€â”€ excelService.ts      # Excel processing and concatenation
â”‚   â”œâ”€â”€ modelService.ts      # Model building services
â”‚   â”œâ”€â”€ exportService.ts     # Enhanced export functionality
â”‚   â”œâ”€â”€ validationService.ts # Comprehensive validation
â”‚   â”œâ”€â”€ metadataService.ts   # State persistence and metadata management
â”‚   â”œâ”€â”€ brandExtractor.ts    # Brand categorization and extraction
â”‚   â”œâ”€â”€ filterService.ts     # Data filtering and analysis
â”‚   â””â”€â”€ wizardManager.ts     # Wizard flow management
â”œâ”€â”€ types/
â”‚   â””â”€â”€ analysis.ts          # TypeScript type definitions
â”œâ”€â”€ constants/
â”‚   â””â”€â”€ appConstants.ts      # Application constants
â”œâ”€â”€ pages/
â”‚   â”œâ”€â”€ Index.tsx           # Main entry point
â”‚   â””â”€â”€ DataScienceWizard.tsx # Enhanced wizard orchestrator
â””â”€â”€ lib/
    â””â”€â”€ utils.ts            # Utility functions
```

### Backend (Dual Architecture - Single Source of Truth)
```
backend/
â”œâ”€â”€ python/                  # PRIMARY Backend - Python FastAPI (Port 8000)
â”‚   â”œâ”€â”€ main.py             # Complete FastAPI application with ALL file operations and data quality enhancement
â”‚   â”œâ”€â”€ requirements.txt    # Python dependencies
â”‚   â”œâ”€â”€ pyrightconfig.json  # Python type checking configuration
â”‚   â”œâ”€â”€ uploads/           # SINGLE SOURCE OF TRUTH - All uploaded files
â”‚   â”‚   â”œâ”€â”€ raw/           # Original uploaded files (timestamped)
â”‚   â”‚   â”œâ”€â”€ intermediate/  # Quality-enhanced files with business columns
â”‚   â”‚   â””â”€â”€ concat/        # Concatenated processed output files
â”‚   â”œâ”€â”€ metadata/          # State persistence and workflow metadata
â”‚   â”‚   â””â”€â”€ concatenation_states/  # JSON state files for workflow continuity
â”‚   â”œâ”€â”€ processed/         # Legacy concatenated files (backward compatibility)
â”‚   â”œâ”€â”€ scripts/           # Startup and utility scripts
â”‚   â”‚   â”œâ”€â”€ start_backend.ps1
â”‚   â”‚   â”œâ”€â”€ start_backend.bat
â”‚   â”‚   â””â”€â”€ activate_venv.*
â”‚   â””â”€â”€ __pycache__/       # Python bytecode cache
â””â”€â”€ nodejs/                 # AUXILIARY Backend - Node.js Express (Port 3001)
    â”œâ”€â”€ config/
    â”‚   â””â”€â”€ constants.js    # Backend configuration constants
    â”œâ”€â”€ utils/
    â”‚   â”œâ”€â”€ fileValidator.js # File validation utilities
    â”‚   â””â”€â”€ timestampGenerator.js # Timestamp generation utilities
    â”œâ”€â”€ services/           # Auxiliary business logic services
    â”‚   â”œâ”€â”€ fileUploadHandler.js # NOT USED for file operations
    â”‚   â”œâ”€â”€ fileReader.js   # Auxiliary file reading utilities
    â”‚   â”œâ”€â”€ filterManager.js # Filter column management
    â”‚   â”œâ”€â”€ metadataManager.js # Metadata Excel file operations
    â”‚   â””â”€â”€ brandHandler.js # Brand name processing
    â”œâ”€â”€ routes/             # Auxiliary API endpoint routes
    â”‚   â”œâ”€â”€ fileRoutes.js   # NOT USED for file operations
    â”‚   â”œâ”€â”€ filterRoutes.js # Filter management endpoints
    â”‚   â”œâ”€â”€ brandRoutes.js  # Brand management endpoints
    â”‚   â””â”€â”€ metadataRoutes.js # Metadata management endpoints
    â”œâ”€â”€ metadata/           # Metadata Excel files
    â”œâ”€â”€ package.json        # Node.js dependencies
    â”œâ”€â”€ server.js           # Express server (auxiliary operations only)
    â””â”€â”€ README.md           # Backend documentation
```

## ğŸ”„ Application Flow

### 13-Step Wizard Process

1. **User Type Selection** - Brand Leader vs Data Scientist
2. **Analysis Type** - MMM Template vs Fresh Analysis
3. **Analysis Mode** - New vs Existing Analysis
4. **Data Upload** - File upload with validation
5. **Data Concatenation** - Select and concatenate Excel sheets *(NEW)*
6. **Data Summary** - Statistical overview and quality assessment
7. **Brand Selection** - Choose target brand for analysis
8. **Filter Selection** - Select columns for filtering
9. **EDA (Exploratory Data Analysis)** - Correlation matrix, distributions
10. **Expected Signs** - Define variable relationships
11. **Model Building** - Select variables and model type
12. **Model Results** - Display coefficients, statistics, diagnostics
13. **Optimizer** - Scenario optimization and budget allocation

## ğŸ›ï¸ Key Components

### State Management (`AnalysisContext.tsx`)
```typescript
interface AppState {
  userType: UserType | null;
  analysisType: AnalysisType | null;
  analysisMode: AnalysisMode | null;
  analysisData: AnalysisData | null;
  selectedBrand: string;
  filterColumns: string[];
  modelResult: ModelResult | null;
  scenarioInputs: ScenarioInput[];
  currentStep: number;
}
```

### Data Processing (`dataProcessor.ts`)
- Mock data generation for demonstration
- File validation and processing
- Statistical calculations
- Chart data preparation

### Model Service (`modelService.ts`)
- Model result generation
- Quality assessment
- Optimization algorithms
- Statistical validations

### Type System (`analysis.ts`)
Comprehensive type definitions for:
- Data structures
- Model configurations
- Analysis states
- User interactions

## ğŸ¨ Design System

### Color Palette
- **Primary**: Blue gradient (HSL-based)
- **Accent**: Purple highlights
- **Success/Warning/Error**: Semantic colors
- **Gradients**: Defined in CSS custom properties

### Component Variants
- Buttons: default, outline, secondary, destructive
- Cards: default, with status indicators
- Badges: semantic color coding
- Tables: responsive with status indicators

## ğŸ§© Modularity Features

### Component Independence
- Each step is completely self-contained
- No cross-dependencies between step components
- Reusable UI components with clear props

### Service Layer
- Business logic separated from UI
- Testable service functions
- Clear data transformation pipelines

### Constants Management
- Centralized configuration
- Type-safe constants
- Easy to modify thresholds and settings

## ğŸ“Š Data Visualization

### Chart Components
- **DataDistributionChart**: Handles numeric and categorical data
- **Correlation Matrix**: Color-coded relationship visualization
- **Progress Indicators**: Model quality and completion status

### Chart Features
- Responsive design
- Interactive tooltips
- Semantic color coding
- Multiple chart types (histogram, bar, progress)

## ğŸ”§ Key Features

### Data Upload & Processing
- Drag & drop file upload
- File type validation (CSV, Excel)
- Mock data generation for demo
- Statistical summary generation

### Model Building
- Multiple model types (Linear, Log-Linear, Ridge, Bayesian)
- Variable selection interface
- Real-time result updates
- Quality assessment metrics

### Optimization Engine
- Scenario planning interface
- Auto-optimization algorithms
- Impact calculations
- Export functionality

### Export Capabilities
- CSV export for scenarios
- JSON export for complete results
- Formatted reports

## ğŸš€ Getting Started

### Prerequisites
```bash
Node.js 16+
npm or yarn
```

### Installation
```bash
npm install
npm run dev
```

### Key Dependencies
- React 18.3.1
- TypeScript
- Tailwind CSS
- @radix-ui components
- Recharts
- React Hook Form

## ğŸ”„ State Flow

1. **User Selection** â†’ Context State Update
2. **Data Upload** â†’ File Processing â†’ Mock Data Generation
3. **Analysis Steps** â†’ Progressive State Building (Fixed: Now uses WizardManager for proper step navigation)
4. **Model Building** â†’ Result Generation â†’ Context Update
5. **Optimization** â†’ Scenario Management â†’ Export

### Navigation Fix (2024-12-20)
- **Issue Fixed**: Step navigation was skipping steps 2 and 4
- **Solution**: Updated AnalysisContext to use WizardManager.getNextStep() instead of direct increment
- **React Router**: Added v7 future flags to eliminate warnings

### Multi-Page Architecture (2024-12-20)
- **Architecture Change**: Converted from single-page wizard to multi-page routing system
- **Individual Routes**: Each step now has its own URL (`/step/1/user-type` through `/step/13/optimizer`)
- **Route Protection**: Each page validates prerequisites and redirects if needed
- **Improved UX**: Users can bookmark steps, use browser navigation, and share specific steps
- **Clean Navigation**: Removed auto-navigation from step components, handled by page components

### Data Concatenation Feature (2024-12-20)
- **New Step Added**: Step 5 - Data Concatenation between upload and summary
- **Multi-Sheet Support**: Users can select which Excel sheets to concatenate
- **Step-by-Step Algorithm**: Intelligent column alignment preserving first sheet structure
- **Column Handling**: Missing columns filled with NaN, new columns added dynamically
- **Data Lineage**: Source_Sheet column tracks origin of each row
- **Single Backend Integration**: All processing happens in Python backend exclusively
- **Real Data Processing**: No mock data fallbacks, actual Excel data processing
- **Real Data Preview**: Backend returns actual first 5 rows of concatenated data for preview
- **Interactive UI**: Checkbox selection with simplified interface (removed selected sheets display)
- **Step Renumbering**: All subsequent steps shifted by +1 (now 13 total steps)

### Data Quality Enhancement Feature (2024-12-23)
- **Automatic Column Filtering**: Removes columns with <18 valid data records during file enhancement
- **Business Column Protection**: PackSize, Region, Channel, Month columns always preserved
- **Enhanced File Processing**: Raw â†’ Data Quality Filter â†’ Business Column Enhancement â†’ Intermediate storage
- **Comprehensive Tracking**: Records all removed columns by sheet for transparency
- **Smart Data Validation**: Non-null, non-empty, non-NaN record counting for quality assessment
- **Enhanced UI Feedback**: Blue-themed data quality information cards with expandable details
- **Dual Enhancement Process**: Combines business column addition with automatic quality filtering
- **Performance Optimization**: Cleaner datasets with fewer empty columns for better analysis
- **User Transparency**: Complete breakdown of data quality improvements in success messages
- **Enhanced API Response**: Comprehensive data quality metrics in modification responses

### Single Backend Architecture (2024-12-20)
- **Architecture Simplification**: Eliminated complex dual backend synchronization
- **Single Source of Truth**: All files stored in `backend/python/uploads/` exclusively
- **Python Backend Primary**: Handles ALL file operations (upload, processing, concatenation)
- **Node.js Backend Auxiliary**: Used only for specialized metadata and auxiliary operations
- **No File Duplication**: Files stored once, accessed directly
- **Enhanced Debugging**: Always know exactly where files are located
- **Performance Improvement**: No cross-backend communication overhead
- **Error Reduction**: Eliminated 404 errors due to file location mismatches

### Step-by-Step Concatenation Algorithm (2024-12-20)
```python
# Intelligent Column Alignment Process
1. First sheet becomes base structure (all columns and rows preserved)
2. Each subsequent sheet processed individually:
   - Missing columns in new sheet â†’ filled with NaN
   - New columns in new sheet â†’ added to result, previous data filled with NaN
   - Column order maintained consistently
   - Source_Sheet column added for data lineage
3. Final concatenation with proper pandas operations
```

### Data Preview Enhancement (2024-12-20)
- **Real Data Preview**: Backend now returns actual first 5 rows of concatenated data
- **No Mock Data**: Eliminated frontend mock data generation for accurate previews
- **UI Simplification**: Removed Selected Sheets display section for cleaner interface
- **Accurate Information**: Preview shows exactly what will be in the downloadable file
- **Better User Experience**: Users see their actual data instead of generated samples

## ğŸ¯ Extension Points

### Adding New Steps
1. Create step component in `components/steps/`
2. Create page component in `pages/steps/`
3. Add route in `App.tsx` routing
4. Update step configuration in `stepConfig.ts`
5. Implement state management in `AnalysisContext`
6. Add route protection and navigation logic

### Adding New Chart Types
1. Create chart component in `components/charts/`
2. Implement data transformation
3. Add responsive design
4. Include in relevant steps

### Adding New Model Types
1. Extend `ModelService`
2. Update type definitions
3. Add UI selection option
4. Implement result processing

## ğŸ” Code Quality

### TypeScript Coverage
- 100% TypeScript usage
- Strict type checking
- Comprehensive interfaces
- Type-safe state management

### Component Design
- Single Responsibility Principle
- Clear prop interfaces
- Minimal external dependencies
- Reusable and composable

### Performance
- Lazy component loading ready
- Efficient re-rendering
- Optimized chart rendering
- Minimal bundle size

## ğŸ§ª Testing Strategy

### Recommended Testing
- Unit tests for services
- Component testing for steps
- Integration tests for state flow
- E2E tests for complete wizard

### Test Files Structure
```
src/
â”œâ”€â”€ __tests__/
â”‚   â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ components/
â”‚   â””â”€â”€ integration/
```

## ğŸš€ Deployment

The application is ready for deployment with:
- Production build optimization
- Environment variable support
- Static asset optimization
- Modern browser support

## ğŸ“ Contributing

### Code Style
- Use TypeScript for all new files
- Follow existing component patterns
- Maintain design system consistency
- Add proper type definitions

### Adding Features
1. Plan component structure
2. Define types first
3. Implement service layer
4. Build UI components
5. Update documentation

## ğŸ‰ Architecture Benefits

### Simplified Development
- **Single Backend Focus**: Developers work with one primary backend system
- **Clear File Flow**: Upload â†’ Process â†’ Concatenate in single location
- **Reduced Complexity**: No cross-backend synchronization to debug
- **Predictable Behavior**: Files always in expected location

### Enhanced Reliability
- **No Mock Data Fallbacks**: Real Excel processing with actual user data
- **Robust Error Handling**: Detailed logging and user feedback
- **File Location Certainty**: Single source of truth eliminates confusion
- **Step-by-Step Processing**: Intelligent column alignment preserves data integrity

### Improved Performance
- **Direct File Access**: No network overhead between backends
- **Efficient Processing**: pandas operations optimized for large datasets
- **Reduced Memory Usage**: No file duplication across systems
- **Faster Debugging**: Clear error messages with file location details

---

This codebase represents a **production-ready, simplified architecture** designed for scalability, maintainability, and ease of understanding. The single-backend approach eliminates common debugging issues while providing robust Excel processing capabilities for real-world data science workflows.

**Last Updated**: 2024-12-23 - Enhanced Data Quality Filtering & Business Column Enhancement Implementation